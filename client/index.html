<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Tracked Controls</title>
    <meta name="description" content="Tracked Controls â€“ A-Frame">
    <script src="lib/aframe/aframe-master.js"></script>
    <script src="components/aabb-collider.js"></script>
    <script src="components/grab.js"></script>
    <script src="components/ground.js"></script>
    <script src="shaders/skyGradient.js"></script>
  </head>
  <body>
    <a-scene fog="color: #bc483e; near: 0; far: 65;">
      <a-assets>
        <a-mixin id="cube"
                 geometry="primitive: box; height: 0.30; width: 0.30; depth: 0.30"
                 material="color: #EF2D5E;"></a-mixin>
        <a-mixin id="cube-collided"
                 material="color: #F2E646;"></a-mixin>
        <a-mixin id="cube-grabbed"
                 material="color: #F2E646;"></a-mixin>
      </a-assets>
      <!-- Hands -->
      <a-entity id="left_hand" hand-controls="left" aabb-collider="objects: .cube;" grab></a-entity>
      <a-entity id="right_hand" hand-controls="right" aabb-collider="objects: .cube;" grab></a-entity>

      <!-- A-Frame cubes -->
      <a-entity position="0 0 -0.5">
        <a-entity class="cube" mixin="cube" position="0.30 1.65 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="0 1.95 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="-0.30 1.65 0"></a-entity>

        <a-entity class="cube" mixin="cube" position="0.60 1.35 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="0.60 1.05 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="0.60 0.75 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="0.60 0.45 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="0.60 0.15 0"></a-entity>

        <a-entity class="cube" mixin="cube" position="0.30 0.75 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="0 0.75 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="-0.30 0.75 0"></a-entity>

        <a-entity class="cube" mixin="cube" position="-0.60 1.35 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="-0.60 1.05 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="-0.60 0.75 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="-0.60 0.45 0"></a-entity>
        <a-entity class="cube" mixin="cube" position="-0.60 0.15 0"></a-entity>

        <!-- Environment -->
        <a-entity id="sky"
                  geometry="primitive: sphere; radius: 65;"
                  material="shader: skyGradient; colorTop: #353449; colorBottom: #BC483E; side: back"></a-entity>
         <a-entity ground></a-entity>
         <a-entity light="type: point; color: #f4f4f4; intensity: 0.2; distance: 0" position="8 10 18"></a-entity>
         <a-entity light="type: point; color: #f4f4f4; intensity: 0.6; distance: 0" position="-8 10 -18"></a-entity>
         <a-entity light="type: ambient; color: #f4f4f4; intensity: 0.4;" position="-8 10 -18"></a-entity>
      </a-entity>
      <a-camera></a-camera>

    </a-scene>
    <script>
        const leftHand = document.getElementById('left_hand');
        const rightHand = document.getElementById('right_hand');
        let ws = new WebSocket('ws://' + window.location.host);
        let data = {};
        let allEventTypes = [ 'triggerdown', 'triggerup', 'gripdown', 'gripup'];
        let leftEventTypes = ['Xdown', 'Xup'];
        let rightEventTypes = ['Adown', 'Aup'];
        let registerEventListener = function(eventTypes, hand) {
            for (let i = 0; i < eventTypes.length; i++) {
                let eventType = eventTypes[i];
                hand.addEventListener(eventType, (event) => {
                    data = {};
                    let hand_id = event['target']['id'];
                    data[eventType] = {};
                    data[eventType]['hand_id'] = hand_id;
                    data['position'] = hand.getAttribute('position');
                    data['rotation'] = hand.getAttribute('position');
                    console.log('JSON.stringify(data): ',JSON.stringify(data));
                    ws.send(JSON.stringify(data));
                });
            }
        }
        ws.onopen = function () {
            registerEventListener(allEventTypes, leftHand);
            registerEventListener(allEventTypes, rightHand);
            registerEventListener(leftEventTypes, leftHand);
            registerEventListener(rightEventTypes, rightHand);
            
            setInterval(() => {
                data['position'] = leftHand.getAttribute('position');
                data['rotation'] = leftHand.getAttribute('rotation');
                console.log('position: ', data['position']);
                console.log('rotation: ', data['rotation']);
                // ws.send(JSON.stringify(data));
            }, 2000)

        }

        ws.onmessage = function (ev) {
            // console.log(ev);
        }
    </script>
  </body>
</html>
